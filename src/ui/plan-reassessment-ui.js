/**
 * @file plan-reassessment-ui.js
 * @description M√≥dulo de UI para gerenciar o Quadro de Carga Semanal, permitindo
 * que o usu√°rio visualize a distribui√ß√£o de seus planos e inicie a reavalia√ß√£o.
 * INCLUI FUNCIONALIDADE DE DRAG & DROP PARA DESKTOP E INTERA√á√ÉO DE TOQUE SEGURA PARA MOBILE.
 */

// --- Importa√ß√µes de Elementos do DOM ---
import {
    planReassessmentSection,
    closeReassessmentButton,
    reassessmentGrid,
    reassessmentLegendList,
    syncPlansButton,
} from './dom-elements.js';

// --- Estado Interno e Callbacks ---
let state = {
    callbacks: {
        onClose: null,
        onPlanSelect: null,
        onUpdatePlanDays: null,
        onSyncRequest: null,
    },
};

// --- Fun√ß√µes Privadas de Renderiza√ß√£o ---

/**
 * Renderiza a grade de dias e a legenda com base nos planos do usu√°rio.
 * @private
 * @param {Array<object>} allUserPlans - A lista completa de planos do usu√°rio.
 */
function _renderGridAndLegend(allUserPlans) {
    reassessmentGrid.innerHTML = '';
    reassessmentLegendList.innerHTML = '';

    if (!allUserPlans || allUserPlans.length === 0) {
        reassessmentGrid.innerHTML = '<p>Nenhum plano ativo encontrado para reavaliar.</p>';
        return;
    }

    const weeklyLoad = {};
    const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
    const activePlansForLegend = new Map();
    const CHAPTER_OVERLOAD_THRESHOLD = 20; // Limite para alerta de sobrecarga

    // 1. Calcular a "carga" de cap√≠tulos para cada plano
    allUserPlans.forEach(plan => {
        const totalReadingDays = Object.keys(plan.plan || {}).length;
        if (totalReadingDays === 0) return; // Ignora planos vazios

        const avgChapters = Math.ceil(plan.totalChapters / totalReadingDays);
        if (avgChapters < 1) return;

        (plan.allowedDays || []).forEach(dayIndex => {
            if (dayIndex >= 0 && dayIndex <= 6) {
                if (!weeklyLoad[dayIndex]) {
                    weeklyLoad[dayIndex] = [];
                }
                weeklyLoad[dayIndex].push({
                    id: plan.id,
                    icon: plan.icon || 'üìñ',
                    chapters: avgChapters
                });
            }
        });
        
        if (!activePlansForLegend.has(plan.id)) {
            activePlansForLegend.set(plan.id, { icon: plan.icon || 'üìñ', name: plan.name || 'Plano sem nome' });
        }
    });

    // 2. Renderizar as colunas da grade no DOM
    daysOfWeek.forEach((dayName, index) => {
        const dayColumn = document.createElement('div');
        dayColumn.className = 'reassessment-day-column';
        dayColumn.dataset.day = index;
        
        let entriesHTML = '';
        let totalChaptersThisDay = 0;

        if (weeklyLoad[index]) {
            weeklyLoad[index].sort((a, b) => b.chapters - a.chapters);

            weeklyLoad[index].forEach(entry => {
                totalChaptersThisDay += entry.chapters;
                entriesHTML += `
                    <div class="reassessment-plan-entry" data-plan-id="${entry.id}" draggable="true" title="Arraste para remanejar (desktop) ou toque para mover (mobile)">
                        <span class="plan-icon">${entry.icon}</span>
                        <span class="chapter-count">${entry.chapters} cap.</span>
                    </div>
                `;
            });
        }
        
        if (totalChaptersThisDay > CHAPTER_OVERLOAD_THRESHOLD) {
            dayColumn.classList.add('overload');
        }

        const totalLoadHTML = `<span class="total-load">Total: ${totalChaptersThisDay} caps</span>`;
        dayColumn.innerHTML = `<div class="reassessment-day-header">${dayName}${totalLoadHTML}</div><div class="day-entries">${entriesHTML}</div>`;
        reassessmentGrid.appendChild(dayColumn);
    });

    // 3. Renderizar a legenda dos planos ativos
    if (activePlansForLegend.size > 0) {
        activePlansForLegend.forEach(planData => {
            reassessmentLegendList.innerHTML += `
                <div class="reassessment-legend-item">
                    <span class="plan-icon">${planData.icon}</span>
                    <span>${planData.name}</span>
                </div>
            `;
        });
    } else {
        reassessmentLegendList.innerHTML = '<p>Nenhum plano com √≠cone e nome para exibir na legenda.</p>';
    }
}

// --- Fun√ß√µes P√∫blicas (API do M√≥dulo) ---

/**
 * Inicializa o m√≥dulo, configurando os listeners para clique, Drag & Drop e sincroniza√ß√£o.
 * @param {object} callbacks - Objeto contendo os callbacks { onClose, onPlanSelect, onUpdatePlanDays, onSyncRequest }.
 */
export function init(callbacks) {
    state.callbacks = { ...state.callbacks, ...callbacks };

    closeReassessmentButton.addEventListener('click', () => state.callbacks.onClose?.());
    syncPlansButton.addEventListener('click', () => state.callbacks.onSyncRequest?.());

    // --- IN√çCIO DA ALTERA√á√ÉO: L√≥gica de intera√ß√£o dual (Desktop vs. Mobile) ---
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    if (isTouchDevice) {
        // --- L√ìGICA DE TOQUE (MOBILE) ---
        let selectedPlanForMove = null;

        reassessmentGrid.addEventListener('click', (event) => {
            const planEntry = event.target.closest('.reassessment-plan-entry');
            const dayColumn = event.target.closest('.reassessment-day-column');

            // Fun√ß√£o para resetar a sele√ß√£o
            const resetSelection = () => {
                if (selectedPlanForMove) {
                    selectedPlanForMove.classList.remove('selected-for-move');
                }
                document.querySelectorAll('.reassessment-day-column.drop-target').forEach(col => col.classList.remove('drop-target'));
                selectedPlanForMove = null;
            };

            if (planEntry && !selectedPlanForMove) {
                // PRIMEIRO TOQUE: Seleciona um plano para mover
                selectedPlanForMove = planEntry;
                planEntry.classList.add('selected-for-move');
                document.querySelectorAll('.reassessment-day-column').forEach(col => col.classList.add('drop-target'));
                // Impede que o clique no mesmo item acione o onPlanSelect de edi√ß√£o
                event.stopPropagation();
            } else if (dayColumn && selectedPlanForMove) {
                // SEGUNDO TOQUE: Toca em uma coluna de destino para mover o plano
                const planId = selectedPlanForMove.dataset.planId;
                const sourceColumn = selectedPlanForMove.closest('.reassessment-day-column');
                const sourceDay = parseInt(sourceColumn.dataset.day, 10);
                const targetDay = parseInt(dayColumn.dataset.day, 10);

                if (sourceDay !== targetDay) {
                     // Adiciona uma confirma√ß√£o para evitar toques acidentais
                     const dayName = dayColumn.querySelector('.reassessment-day-header').firstChild.textContent;
                     if (window.confirm(`Tem certeza que deseja mover este plano para ${dayName}?`)) {
                        state.callbacks.onUpdatePlanDays?.(planId, sourceDay, targetDay);
                    }
                }
                resetSelection();

            } else if (planEntry && selectedPlanForMove && planEntry === selectedPlanForMove) {
                // Tocar novamente no mesmo plano cancela a sele√ß√£o
                 resetSelection();
            } else if (planEntry) {
                 // Tocar em um plano enquanto outro est√° selecionado para mover, edita o plano tocado
                 state.callbacks.onPlanSelect?.(planEntry.dataset.planId);
            } else {
                 // Tocar fora de qualquer √°rea v√°lida cancela a sele√ß√£o
                 resetSelection();
            }
        });

    } else {
        // --- L√ìGICA DE DRAG & DROP (DESKTOP) ---
        reassessmentGrid.addEventListener('click', (event) => {
            const planEntry = event.target.closest('.reassessment-plan-entry');
            if (planEntry && planEntry.dataset.planId) {
                state.callbacks.onPlanSelect?.(planEntry.dataset.planId);
            }
        });

        let draggedItem = null;
        reassessmentGrid.addEventListener('dragstart', (e) => {
            const target = e.target.closest('.reassessment-plan-entry');
            if (target) {
                draggedItem = target;
                setTimeout(() => target.classList.add('dragging'), 0);
                e.dataTransfer.setData('text/plain', target.dataset.planId);
                e.dataTransfer.effectAllowed = 'move';
            }
        });
        
        reassessmentGrid.addEventListener('dragend', () => {
            draggedItem?.classList.remove('dragging');
            draggedItem = null;
        });
        
        reassessmentGrid.addEventListener('dragover', (e) => e.preventDefault());

        reassessmentGrid.addEventListener('dragenter', (e) => {
            const targetColumn = e.target.closest('.reassessment-day-column');
            if (targetColumn) {
                e.preventDefault();
                targetColumn.classList.add('over');
            }
        });

        reassessmentGrid.addEventListener('dragleave', (e) => {
            e.target.closest('.reassessment-day-column')?.classList.remove('over');
        });

        reassessmentGrid.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetColumn = e.target.closest('.reassessment-day-column');
            document.querySelectorAll('.reassessment-day-column.over').forEach(col => col.classList.remove('over'));

            if (targetColumn && draggedItem) {
                const planId = draggedItem.dataset.planId;
                const sourceColumn = draggedItem.closest('.reassessment-day-column');
                const sourceDay = parseInt(sourceColumn.dataset.day, 10);
                const targetDay = parseInt(targetColumn.dataset.day, 10);

                if (sourceDay !== targetDay) {
                    state.callbacks.onUpdatePlanDays?.(planId, sourceDay, targetDay);
                }
            }
        });
    }
    // --- FIM DA ALTERA√á√ÉO ---
}

/**
 * Renderiza o conte√∫do do quadro de reavalia√ß√£o com os dados mais recentes.
 * @param {Array<object>} allUserPlans - A lista completa de planos do usu√°rio.
 */
export function render(allUserPlans) {
    _renderGridAndLegend(allUserPlans);
}

/**
 * Mostra a se√ß√£o de reavalia√ß√£o de planos.
 */
export function show() {
    planReassessmentSection.style.display = 'block';
    window.scrollTo(0, 0);
}

/**
 * Esconde a se√ß√£o de reavalia√ß√£o de planos.
 */
export function hide() {
    planReassessmentSection.style.display = 'none';
}
